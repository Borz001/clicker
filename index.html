<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Online Clicker Race</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<h1>üöó Online Clicker Race</h1>
<p>Time left: <span id="timer">30</span></p>

<div id="raceContainer">
    <div class="line" style="top:0px"></div>
    <div class="line" style="top:-150px"></div>
    <div class="line" style="top:-300px"></div>

    <div id="myCar" class="car"></div>
</div>

<div id="nicknameContainer">
    <h3>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫:</h3>
    <input type="text" id="nicknameInput" placeholder="–í–∞—à –Ω–∏–∫">
    <button id="startBtn">–°—Ç–∞—Ä—Ç</button>
</div>

<div id="game" style="display:none;">
    <button id="clickBtn">CLICK!</button>

    <h3>Your Score: <span id="myScore">0</span></h3>

    <h3>Players:</h3>
    <div id="players"></div>

    <h3>–õ–∏–¥–µ—Ä–±–æ—Ä–¥:</h3>
    <div id="myResult"></div>
</div>

<script>
const ws = new WebSocket("ws://localhost:8080");

let myId = null;
let myScore = 0;
let myNick = "";

const timerEl = document.getElementById("timer");
const myScoreEl = document.getElementById("myScore");
const playersEl = document.getElementById("players");
const myCar = document.getElementById("myCar");
const raceContainer = document.getElementById("raceContainer");
const myResultEl = document.getElementById("myResult");

const nicknameInput = document.getElementById("nicknameInput");
const startBtn = document.getElementById("startBtn");
const gameDiv = document.getElementById("game");
const nicknameContainer = document.getElementById("nicknameContainer");

// –°—Ç–∞—Ä—Ç –∏–≥—Ä—ã –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞ –Ω–∏–∫–∞
startBtn.onclick = () => {
    const nick = nicknameInput.value.trim();
    if (!nick) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫!");
    myNick = nick;
    ws.send(JSON.stringify({ type: "join", name: myNick }));
};

// +1 –∞–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –∫–ª–∏–∫–µ
function showPlusOne() {
    const p = document.createElement("div");
    p.className = "plusOne";
    p.innerHTML = "+1";
    p.style.left = (125 + Math.random()*40) + "px";
    p.style.bottom = (myScore*5 + 20) + "px";
    raceContainer.appendChild(p);
    setTimeout(() => p.remove(), 700);
}

// –ö–ª–∏–∫
document.getElementById("clickBtn").onclick = () => {
    ws.send(JSON.stringify({ type: "click" }));
    showPlusOne();
};

// WS —Å–æ–æ–±—â–µ–Ω–∏—è
ws.onmessage = (msg) => {
    const data = JSON.parse(msg.data);

    if (data.type === "welcome") {
        myId = data.id;
        nicknameContainer.style.display = "none";
        gameDiv.style.display = "block";
    }

    if (data.type === "state") {
        timerEl.textContent = data.timeLeft;

        playersEl.innerHTML = "";
        myScore = 0;

        data.players.forEach(p => {
            playersEl.innerHTML += `${p.name}: ${p.score}<br>`;
            if (p.id === myId) myScore = p.score;
        });

        myScoreEl.textContent = myScore;
        myCar.style.bottom = (myScore * 5) + "px";
    }

    if (data.type === "game_over") {
        let leaderboard = "";
        for(const [nick, score] of Object.entries(data.scores)) {
            leaderboard += `${nick}: ${score}<br>`;
        }
        myResultEl.innerHTML = `–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤:<br>${leaderboard}`;
        alert(`GAME OVER! –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${data.winner}`);
    }
};
</script>

</body>
</html>
