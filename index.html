<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Online Multiplayer Race</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<h1>ðŸš— Online Clicker Race</h1>
<p>Time left: <span id="timer">30</span></p>

<div id="raceContainer">
    <div class="line" style="top:0px"></div>
    <div class="line" style="top:-150px"></div>
    <div class="line" style="top:-300px"></div>

    <div id="cars"></div>
</div>

<div id="nicknameContainer">
    <h3>Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð²Ð°Ñˆ Ð½Ð¸Ðº:</h3>
    <input type="text" id="nicknameInput" placeholder="Ð’Ð°Ñˆ Ð½Ð¸Ðº">
    <button id="startBtn">Ð¡Ñ‚Ð°Ñ€Ñ‚</button>
</div>

<div id="game" style="display:none;">
    <button id="clickBtn">CLICK!</button>

    <h3>Your Score: <span id="myScore">0</span></h3>

    <h3>Players:</h3>
    <div id="players"></div>

    <h3>Ð›Ð¸Ð´ÐµÑ€Ð±Ð¾Ñ€Ð´:</h3>
    <div id="myResult"></div>
</div>

<script>
const ws = new WebSocket("ws://" + location.hostname + ":8085");

let myId = null;
let myScore = 0;

const carsContainer = document.getElementById("cars");
const playersEl = document.getElementById("players");
const timerEl = document.getElementById("timer");

const nicknameInput = document.getElementById("nicknameInput");
const startBtn = document.getElementById("startBtn");
const gameDiv = document.getElementById("game");
const nicknameContainer = document.getElementById("nicknameContainer");

startBtn.onclick = () => {
    const nickname = nicknameInput.value.trim();
    if (!nickname) return alert("Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¸Ðº!");
    ws.send(JSON.stringify({ type: "join", name: nickname }));
};

document.getElementById("clickBtn").onclick = () => {
    ws.send(JSON.stringify({ type: "click" }));
    const p = document.createElement("div");
    p.className = "plusOne";
    p.innerHTML = "+1";
    p.style.left = (125 + Math.random()*40) + "px";
    p.style.bottom = (myScore*5 + 20) + "px";
    const raceContainer = document.getElementById("raceContainer");
    raceContainer.appendChild(p);
    setTimeout(() => p.remove(), 700);
};

ws.onmessage = (msg) => {
    const data = JSON.parse(msg.data);
    if (data.type === "welcome") {
        myId = data.id;
        nicknameContainer.style.display = "none";
        gameDiv.style.display = "block";
    }
    if (data.type === "state") {
        timerEl.textContent = data.timeLeft;
        playersEl.innerHTML = "";
        carsContainer.innerHTML = "";
        data.players.forEach((p, idx) => {
            playersEl.innerHTML += `${p.name}: ${p.score}<br>`;
            const car = document.createElement("div");
            car.className = "car";
            car.style.background = p.color;
            if (p.id === myId) {
                car.classList.add("myCar");
                myScore = p.score;
            }
            const laneOffset = (idx - Math.floor(data.players.length/2)) * 60;
            car.style.left = `calc(50% + ${laneOffset}px)`;
            car.style.bottom = (p.score * 5) + "px";
            carsContainer.appendChild(car);
        });
        document.getElementById("myScore").textContent = myScore;
    }
    if (data.type === "game_over") {
        let text = "";
        for (const [nick, sc] of Object.entries(data.scores)) {
            text += `${nick}: ${sc}<br>`;
        }
        document.getElementById("myResult").innerHTML = text;
        alert("GAME OVER! ÐŸÐ¾Ð±ÐµÐ´Ð¸Ñ‚ÐµÐ»ÑŒ: " + data.winner);
    }
};
</script>

</body>
</html>
